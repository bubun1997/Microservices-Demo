package com.soumya.app.service;

import java.util.List;
import java.util.stream.Collectors;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Scope;
import org.springframework.http.MediaType;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestClient;

import com.soumya.app.entity.Customer;
import com.soumya.app.repository.CustomerRepository;

import lombok.extern.log4j.Log4j2;


@Service
@Scope(scopeName = "singleton")
@Log4j2
public class CustomerService {
	
	@Autowired
	private CustomerRepository customerRepository;
	
	@Autowired
	private RestClient restClient;
	
	public Customer addCustomer(Customer cust) {
		
		 Customer savedCustomer = this.customerRepository.save(cust);
		 
		 String response = restClient.
		   post().
		   uri("/products")
		  .contentType(MediaType.APPLICATION_JSON) 
		  .body(cust.
				  getProducts().
				  stream().
				  map( product -> {
					    product.setCustomerid(savedCustomer.getCustomerId());
					    return product;
				  }).collect(Collectors.toList())
				  
			   ).retrieve().body(String.class);
		 
         log.info(response);
         
		return savedCustomer;
	}

	public List<Customer> getAllCustomers(){
		
		List<Customer> customers = this.customerRepository.findAll();
		
		this.restClient.
			 get().
			 uri("/products").accept(MediaType.APPLICATION_JSON).
		
		return customers;
	}
}
